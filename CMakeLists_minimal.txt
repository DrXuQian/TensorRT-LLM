cmake_minimum_required(VERSION 3.18)
project(w4a16_minimal CUDA CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CUDA_STANDARD 17)
set(CMAKE_CUDA_ARCHITECTURES 90)

find_package(CUDAToolkit REQUIRED)

# 关键：定义 Hopper TMA
add_definitions(-DCOMPILE_HOPPER_TMA_GEMMS)

# 路径
set(TRTLLM "${CMAKE_CURRENT_SOURCE_DIR}")
set(CUTLASS "${TRTLLM}/3rdparty/cutlass")

# Include 路径
include_directories(
    ${TRTLLM}/cpp/include
    ${TRTLLM}/cpp
    ${TRTLLM}/cpp/include_stubs
    ${TRTLLM}/cpp/include/tensorrt_llm/cutlass_extensions/include
    ${TRTLLM}/cpp/tensorrt_llm/cutlass_extensions/include
    ${CUTLASS}/include
    ${CUTLASS}/tools/util/include
)

# CUDA 编译选项
set(CMAKE_CUDA_FLAGS "${CMAKE_CUDA_FLAGS} -Xcompiler=-fPIC")
set(CMAKE_CUDA_FLAGS "${CMAKE_CUDA_FLAGS} --expt-relaxed-constexpr")
set(CMAKE_CUDA_FLAGS "${CMAKE_CUDA_FLAGS} --expt-extended-lambda")
set(CMAKE_CUDA_FLAGS "${CMAKE_CUDA_FLAGS} -Xcudafe --diag_suppress=186")

# 只编译这一个文件！
add_executable(w4a16_minimal
    w4a16_minimal_test.cu
    cpp/tensorrt_llm/common/logger.cpp
    cpp/tensorrt_llm/common/stringUtils.cpp
    cpp/tensorrt_llm/common/assert.cpp
    cpp/tensorrt_llm/common/tllmException.cpp
)

target_link_libraries(w4a16_minimal CUDA::cudart)

set_target_properties(w4a16_minimal PROPERTIES
    CUDA_SEPARABLE_COMPILATION ON
    CUDA_RESOLVE_DEVICE_SYMBOLS ON
)

message(STATUS "CUTLASS: ${CUTLASS}")
message(STATUS "CUDA Arch: ${CMAKE_CUDA_ARCHITECTURES}")
